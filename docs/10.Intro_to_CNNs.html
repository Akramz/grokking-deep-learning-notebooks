---

title: Neural Learning about Edges and Corners: Intro to Convolutional Neural Networks
keywords: fastai
sidebar: home_sidebar


---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 10.Intro_to_CNNs.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this Chapter:</p>
<ul>
<li>Reusing Weights in Multiple Places.</li>
<li>The Convolutional Layer.</li>
</ul>
<blockquote><p>"The Pooling Operation used in Convolutional Neural Networks is a big mistake, and the fact that is works so well is a disaster". â€” Geoffrey Hinton, from "Ask me anything" on Reddit.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Reusing-Weights-in-multiple-places">Reusing Weights in multiple places<a class="anchor-link" href="#Reusing-Weights-in-multiple-places">&#182;</a></h2><h3 id="If-you-need-to-detect-the-same-feature-in-multiple-places,-use-the-same-weights!">If you need to detect the same feature in multiple places, use the same weights!<a class="anchor-link" href="#If-you-need-to-detect-the-same-feature-in-multiple-places,-use-the-same-weights!">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>The greatest challenge in NNs is that of overfitting.</li>
<li>Overfitting is often caused by having more parameters than necessary to learn a specific data set.</li>
<li>when NNs have a lot of parameters and few training examples, it becomes very easy to overfit.</li>
<li>There's a better method than regularization to counter overfitting, we call it <strong>structure</strong>.<ul>
<li>Structure is when you selectively choose the same group of weights in multiple purposes in a NN.<ul>
<li>Because we believe the same pattern needs to be detected in multiple places.</li>
</ul>
</li>
</ul>
</li>
<li>The most famous and used structure in NNs is called a <strong>convolution</strong>.<ul>
<li>When user in a layer it's called a <strong>convolutional layer</strong>.</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-Convolutional-Layer">The Convolutional Layer<a class="anchor-link" href="#The-Convolutional-Layer">&#182;</a></h2><h3 id="Lots-of-very-small-linear-layers-are-reused-in-every-position,-instead-of-a-single-big-one.">Lots of very small linear layers are reused in every position, instead of a single big one.<a class="anchor-link" href="#Lots-of-very-small-linear-layers-are-reused-in-every-position,-instead-of-a-single-big-one.">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include image.html style="width:33%;" file="static/imgs/10/convolutional_layer.png" %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include image.html style="width:25%;" file="static/imgs/10/step_0.png" %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><strong>You can either sum the outputs of the kernels (element-wise, sum pooling), take the mean element-wise (mean pooling), or take the max value element-wise (max pooling)</strong>.</li>
<li>The last version turns out to be the most popular.</li>
<li>This final matrix is then forward propagated to later layers.</li>
<li>There are a few things to notice in these figures:<ul>
<li><strong>The Top right kernel forward propagate a 1 only if it's focused on a horizontal line</strong>.</li>
<li><strong>The Bottom left kernel forward propagate a 1 only if it's focused on a diagonal line pointing upward and to the right</strong>.</li>
</ul>
</li>
<li>It's important to realize that this technique allows each kernel to search for a certain pattern and mark its existance on every location of the image.</li>
<li>This small-weights-to-large-datasets has a considerable impact on fighting overfitting and increases the networks ability to generalize well.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="A-Simple-Implementation-in-NumPy">A Simple Implementation in NumPy<a class="anchor-link" href="#A-Simple-Implementation-in-NumPy">&#182;</a></h2><h3 id="Just-think-mini-linear-layers,-and-you-already-know-what-you-need-to-know.">Just think mini-linear layers, and you already know what you need to know.<a class="anchor-link" href="#Just-think-mini-linear-layers,-and-you-already-know-what-you-need-to-know.">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>((60000, 28, 28), (60000,), (10000, 28, 28), (10000,))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Visualizing one example:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="mi">89</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.image.AxesImage at 0x12b92b550&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># get example</span>
<span class="n">image_example</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="mi">89</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">/</span><span class="mf">255.</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_image_section</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">row_from</span><span class="p">,</span> <span class="n">row_to</span><span class="p">,</span> <span class="n">col_from</span><span class="p">,</span> <span class="n">col_to</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">layer</span><span class="p">[</span><span class="n">row_from</span><span class="p">:</span><span class="n">row_to</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_from</span><span class="p">:</span><span class="n">col_to</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">get_image_section</span><span class="p">(</span><span class="n">image_example</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.image.AxesImage at 0x12ba05940&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># book implementation.</span>
<span class="k">def</span> <span class="nf">get_image_section</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">row_from</span><span class="p">,</span> <span class="n">row_to</span><span class="p">,</span> <span class="n">col_from</span><span class="p">,</span> <span class="n">col_to</span><span class="p">):</span>
    <span class="n">sub_section</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[:,</span> <span class="n">row_from</span><span class="p">:</span><span class="n">row_to</span><span class="p">,</span> <span class="n">col_from</span><span class="p">:</span><span class="n">col_to</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sub_section</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row_to</span><span class="o">-</span><span class="n">row_from</span><span class="p">,</span> <span class="n">col_to</span><span class="o">-</span><span class="n">col_from</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">get_image_section</span><span class="p">(</span><span class="n">image_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.image.AxesImage at 0x12e2295c0&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Because this method selects a subsection of a batch of input images, you need to call it multiple times (on every location within the image).</li>
<li>Such a "for" loop looks something like this:</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">images</span> <span class="o">=</span> <span class="n">X_train</span>
<span class="n">images</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(60000, 28, 28)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">batch_start</span><span class="p">,</span> <span class="n">batch_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span>
<span class="n">layer_0</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
<span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(7, 28, 28)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">kernel_rows</span><span class="p">,</span> <span class="n">kernel_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
<span class="k">for</span> <span class="n">row_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">kernel_rows</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">kernel_cols</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">get_image_section</span><span class="p">(</span><span class="n">layer_0</span><span class="p">,</span> <span class="n">row_start</span><span class="p">,</span> <span class="n">row_start</span><span class="o">+</span><span class="n">kernel_rows</span><span class="p">,</span> <span class="n">col_start</span><span class="p">,</span> <span class="n">col_start</span><span class="o">+</span><span class="n">kernel_cols</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">expanded_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">expanded_input</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(7, 625, 3, 3)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">es</span> <span class="o">=</span> <span class="n">expanded_input</span><span class="o">.</span><span class="n">shape</span>
<span class="n">flattened_input</span> <span class="o">=</span> <span class="n">expanded_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">es</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">es</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">flattened_input</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(4375, 9)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>In this code, layer_0 is a batch of images 28x28 in shape.</li>
<li>The for loop slides over every subregion in the images, extract and append it to a list called <code>sections</code>.</li>
<li>This list of sections is then concatenated and reshaped in a peculiar way.</li>
<li>Pretend for now that each individual subregion is its own image.</li>
<li>Forward-propagating them through a linear layer with one output neuron is the same as predicting that linear layer over every sub-region in every batch.</li>
<li>The following listing shows the entire NumPy implementation: </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_train</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>((1000, 784), (1000,))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_hot_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">one_hot_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">one_hot_labels</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_images</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_test</span><span class="p">):</span>
    <span class="n">test_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># activation functions</span>
<span class="k">def</span> <span class="nf">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">grad_tanh</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">exps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exps</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">pixels_per_image</span><span class="p">,</span> <span class="n">num_labels</span> <span class="o">=</span> <span class="p">(</span><span class="mi">784</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>

<span class="n">input_rows</span><span class="p">,</span> <span class="n">input_cols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="n">kernel_rows</span><span class="p">,</span> <span class="n">kernel_cols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">num_kernels</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Hidden is of that size because we are training a 1-D Convolutional Layer, not a 2D, and so it&#39;s taking more space (try it).</span>
<span class="n">hidden_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">input_rows</span><span class="o">-</span><span class="n">kernel_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">input_cols</span><span class="o">-</span><span class="n">kernel_cols</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">num_kernels</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">kernels</span> <span class="o">=</span> <span class="mf">0.02</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">kernel_rows</span><span class="o">*</span><span class="n">kernel_cols</span><span class="p">,</span> <span class="n">num_kernels</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.01</span>
<span class="n">weights_1_2</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span>

<span class="n">kernels</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">weights_1_2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>((9, 16), (10816, 10))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_image_section</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">row_from</span><span class="p">,</span> <span class="n">row_to</span><span class="p">,</span> <span class="n">col_from</span><span class="p">,</span> <span class="n">col_to</span><span class="p">):</span>
    <span class="n">sub_section</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[:,</span> <span class="n">row_from</span><span class="p">:</span><span class="n">row_to</span><span class="p">,</span> <span class="n">col_from</span><span class="p">:</span><span class="n">col_to</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sub_section</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row_to</span><span class="o">-</span><span class="n">row_from</span><span class="p">,</span> <span class="n">col_to</span><span class="o">-</span><span class="n">col_from</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Training Loop</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>  <span class="c1"># for each epoch</span>
    <span class="n">correct_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)):</span>  <span class="c1"># for each batch</span>
        <span class="n">batch_start</span><span class="p">,</span> <span class="n">batch_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">batch_size</span><span class="p">),</span> <span class="p">((</span><span class="n">batch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batch_size</span><span class="p">)</span>
        
        <span class="c1"># get input</span>
        <span class="n">layer_0</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
        <span class="n">layer_0</span> <span class="o">=</span> <span class="n">layer_0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        
        <span class="c1"># extract all sections from all batch images</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">kernel_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># +1 by akramz.</span>
            <span class="k">for</span> <span class="n">col_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">kernel_cols</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">get_image_section</span><span class="p">(</span><span class="n">layer_0</span><span class="p">,</span> <span class="n">row_start</span><span class="p">,</span> <span class="n">row_start</span><span class="o">+</span><span class="n">kernel_rows</span><span class="p">,</span> <span class="n">col_start</span><span class="p">,</span> <span class="n">col_start</span><span class="o">+</span><span class="n">kernel_cols</span><span class="p">)</span>
                <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="c1"># [0] 128 batch elements, [1] 676 sections/image, 3x3 section size </span>
        <span class="n">expanded_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">es</span> <span class="o">=</span> <span class="n">expanded_input</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># shape: (128x676, 3x3)</span>
        <span class="n">flattened_input</span> <span class="o">=</span> <span class="n">expanded_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">es</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">es</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># WEIRD STUFF ????</span>
        
        <span class="c1"># forward propagation</span>
        <span class="n">kernel_output</span> <span class="o">=</span> <span class="n">flattened_input</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span>  <span class="c1"># 16 kernels</span>
        <span class="n">layer_1</span> <span class="o">=</span> <span class="n">tanh</span><span class="p">(</span><span class="n">kernel_output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">es</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dropout_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">layer_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">layer_1</span> <span class="o">*=</span> <span class="n">dropout_mask</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">layer_2</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">layer_1</span><span class="p">,</span> <span class="n">weights_1_2</span><span class="p">))</span>
        
        <span class="c1"># count corrects</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">labelset</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">batch_start</span><span class="o">+</span><span class="n">k</span><span class="p">:</span><span class="n">batch_start</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">_inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">layer_2</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">labelset</span><span class="p">))</span>
            <span class="n">correct_count</span> <span class="o">+=</span> <span class="n">_inc</span>
        
        <span class="c1"># back propagation</span>
        <span class="n">layer_2_delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span><span class="o">-</span><span class="n">layer_2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">batch_size</span><span class="o">*</span><span class="n">layer_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">layer_1_delta</span> <span class="o">=</span> <span class="n">layer_2_delta</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights_1_2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad_tanh</span><span class="p">(</span><span class="n">layer_1</span><span class="p">)</span>
        <span class="n">layer_1_delta</span> <span class="o">*=</span> <span class="n">dropout_mask</span>
        <span class="n">weights_1_2</span> <span class="o">+=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">layer_1</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">layer_2_delta</span><span class="p">)</span>
        <span class="n">l1d_reshape</span> <span class="o">=</span> <span class="n">layer_1_delta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kernel_output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">k_udpate</span> <span class="o">=</span> <span class="n">flattened_input</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l1d_reshape</span><span class="p">)</span>
        <span class="n">kernels</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">k_udpate</span>
        
        <span class="c1"># test</span>
        <span class="n">test_correct_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_images</span><span class="p">)):</span>
            <span class="n">layer_0</span> <span class="o">=</span> <span class="n">test_images</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">layer_0</span> <span class="o">=</span> <span class="n">layer_0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">kernel_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">kernel_cols</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="n">get_image_section</span><span class="p">(</span><span class="n">layer_0</span><span class="p">,</span> <span class="n">row_start</span><span class="p">,</span> <span class="n">row_start</span><span class="o">+</span><span class="n">kernel_rows</span><span class="p">,</span> <span class="n">col_start</span><span class="p">,</span> <span class="n">col_start</span><span class="o">+</span><span class="n">kernel_cols</span><span class="p">)</span>
                    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">expanded_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">es</span> <span class="o">=</span> <span class="n">expanded_input</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">flattened_input</span> <span class="o">=</span> <span class="n">expanded_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">es</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">es</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kernel_output</span> <span class="o">=</span> <span class="n">flattened_input</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span> 
            <span class="n">layer_1</span> <span class="o">=</span> <span class="n">tanh</span><span class="p">(</span><span class="n">kernel_output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">es</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> 
            <span class="n">layer_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">layer_1</span><span class="p">,</span><span class="n">weights_1_2</span><span class="p">)</span>
            <span class="n">test_correct_count</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">layer_2</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_labels</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        
    <span class="k">if</span><span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span> <span class="s2">&quot;I:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Test-Acc:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">test_correct_count</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_images</span><span class="p">)))</span><span class="o">+</span> <span class="s2">&quot; Train-Acc:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">correct_count</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>As you can see, swapping out the first layer from the network in chapter 9 with a convolutional layer gives another few percentage points in error reduction.</li>
<li><strong>The output of the convolutional layer is itself also a series of two-dimensional images</strong>.</li>
<li>Most uses of convolutional layers stack multiple layers on top of each other.<ul>
<li>such that each layer treats the previous output as its input.</li>
</ul>
</li>
<li><strong>Stacked Convolutional Layers are one of the main developments that allowed for very deep neural networks.</strong><ul>
<li>&amp; by extension, the popularization of the phrase "deep learning".</li>
</ul>
</li>
<li><strong>It can't be overstressed that this invension was a landmark moment for the field; without it, we might still be in the previous AI Winter even at the time of writing</strong>.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="#Summary">&#182;</a></h2><h3 id="Reusing-weights-is-one-of-the-most-important-innovations-in-deep-learning">Reusing weights is one of the most important innovations in deep learning<a class="anchor-link" href="#Reusing-weights-is-one-of-the-most-important-innovations-in-deep-learning">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>The notion of reusing weights to increase accuracy is hugely important and has an intuitive basis.</li>
<li><strong>Consider what you need to understand to detect that a cat is in an image.</strong><ul>
<li>You first need to understand <strong>colors</strong>.</li>
<li>then <strong>lines and edges</strong>.</li>
<li><strong>Corners &amp; small shapes</strong>.</li>
<li>&amp; finally the combination of such low-level features that corresponds to a cat.</li>
</ul>
</li>
<li>NNs also need to learn such low-level features.</li>
<li>The intelligence for detecting lines and edges is learned in its weights.</li>
<li><strong>But if you use different weights to analyze different parts of an image, each section of the weights has to learn what a line is.</strong></li>
<li><strong>The Structure Trick</strong><ul>
<li><strong>When a Neural Network needs to use the same idea in multiple places, endeavor to use the same weights in multiple places.</strong></li>
<li>This will make the weights more intelligent by giving them more samples (sections) to learn from, increasing generalization.</li>
</ul>
</li>
<li>Many of the biggest developments in deep learning over the past five years are iterations of this idea:<ul>
<li>CNNs, RNNs, Word Embeddings, &amp; the recently published capsule networks can all be viewed through this lens.</li>
</ul>
</li>
<li>When you know you'll need the same idea in multiple places, force it to use the same weights in those places.</li>
</ul>

</div>
</div>
</div>
</div>
 

